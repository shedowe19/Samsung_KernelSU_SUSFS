name: Kernel Build Process
permissions:
  contents: write
  actions: write 

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string

jobs:
  build-samsung-gki:
    name: "${{ inputs.branch }}-${{ inputs.kernel_version }}-${{ inputs.android_version }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
      - name: Check Initial Disk Space
        run: |
          echo "===== Initial Total Disk Space in GB ====="
          df -BG
          
      - name: Download Apache Arrow's util_free_space.sh
        run: |
          curl -L -o util_free_space.sh https://raw.githubusercontent.com/apache/arrow/main/ci/scripts/util_free_space.sh
          chmod +x util_free_space.sh
          ./util_free_space.sh
          
      - name: Check Disk Space After Cleanup
        run: |
          echo "===== Total Disk Space After Cleanup in GB ====="
          df -BG
          
      - name: Set CONFIG Environment Variable
        run: |
          # Set CONFIG dynamically based on inputs values
          CONFIG="${{ inputs.branch }}-${{ inputs.android_version }}-${{ inputs.kernel_version }}"

          # Set CONFIG as an environment variable for future steps
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV

      - name: Clone AnyKernel3 and Other Dependencies
        run: |
          ANYKERNEL_BRANCH="gki-2.0"
          SUSFS_BRANCH="gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}"
          
          git clone https://github.com/WildKernels/AnyKernel3.git -b "$ANYKERNEL_BRANCH"
          git clone https://github.com/WildKernels/kernel_patches.git
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH"
      
      - name: Clone Kernel Source
        run: |
          git clone https://github.com/WildKernels/Samsung_Kernels.git -b ${{ inputs.branch }} $CONFIG

          
      - name: Check Directory Space Usage
        run: |
          echo "===== Total Disk Space After Kernel Download in GB ====="
          df -BG
          
          echo "===== Directory Space Usage in GB ====="
          du -BG -d 1 | sort -nr
          
          echo "===== $CONFIG Directory Space Usage in GB ====="
          cd "$CONFIG"
          du -BG -d 2 | sort -nr

      - name: Add KernelSU
        run: |
          cd "$CONFIG/kernel_platform/common"
          curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh" | bash -s wild

      - name: Getting KernelSU Version
        run: |
          cd "$CONFIG/Wild_KSU/kernel"
          BASE_VERSION=10200
          COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD)
          KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

      - name: Apply SUSFS Patches for KernelSU Variants
        run: |
          cd "$CONFIG"
          
          # Apply compatibility fixes
          SUSFS_VERSION="1.5.12"

          cp ../susfs4ksu/kernel_patches/fs/* ./kernel_platform/common/fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./kernel_platform/common/include/linux/

          # Apply core SUSFS patches
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch ./kernel_platform/common/
          cd kernel_platform/common

          # Pre-SUSFS sed safeguards removed; moved below core patch

          # Apply SUSFS core patch
          patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true

          # Fix SUSFS rejects
          if [[ "${{ inputs.branch }}" == "SM-S928B-Oneui7" || "${{ inputs.branch }}" == "SM-S928B-Oneui8" ]]; then
            cp ../../../kernel_patches/samsung/S24U/* ./
          elif [[ "${{ inputs.branch }}" == "SM-A366B" ]]; then
            cp ../../../kernel_patches/samsung/${{ inputs.branch }}/* ./
          elif [[ "${{ inputs.branch }}" == "SM-A546B" ]]; then
            cp ../../../kernel_patches/samsung/${{ inputs.branch }}/* ./
          fi
          
          patch -p1 < fix_namespace.patch
          patch -p1 < fix_base.patch

          # Post-SUSFS sed safeguards for task_mmu.c 'goto show_pad' handling
          #if ( ( [[ "${{ inputs.android_version }}" == "android12" ]] && [[ "${{ inputs.kernel_version }}" == "5.10" ]] && (( $ACTUAL_SUBLEVEL <= 209 )) ) \
          #     || ( [[ "${{ inputs.android_version }}" == "android13" ]] && [[ "${{ inputs.kernel_version }}" == "5.10" ]] && [[ "${{ inputs.os_patch_level }}" != "2024-05" ]] && (( $ACTUAL_SUBLEVEL <= 209 )) ) \
          #     || ( [[ "${{ inputs.android_version }}" == "android13" ]] && [[ "${{ inputs.kernel_version }}" == "5.15" ]] && [[ "${{ inputs.os_patch_level }}" != "2024-05" ]] && (( $ACTUAL_SUBLEVEL <= 148 )) ) \
          #     || ( [[ "${{ inputs.android_version }}" == "android14" ]] && [[ "${{ inputs.kernel_version }}" == "5.15" ]] && [[ "${{ inputs.os_patch_level }}" != "2024-05" ]] && (( $ACTUAL_SUBLEVEL <= 148 )) ) \
          #     || ( [[ "${{ inputs.android_version }}" == "android14" ]] && [[ "${{ inputs.kernel_version }}" == "6.1" ]] && [[ "${{ inputs.os_patch_level }}" != "2024-05" ]] && (( $ACTUAL_SUBLEVEL <= 75 )) ) ); then
          #  sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
          #fi

          # Apply additional SUSFS patches for Android 13 5.15 compatibility
          #if [[ "${{ inputs.android_version }}" == "android13" ]] && [[ "${{ inputs.kernel_version }}" == "5.15" ]] && (( ${{ inputs.sub_level }} <= 41 )); then
          #  cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_fdinfo.c.patch ./
          #  patch -p1 < fix_fdinfo.c.patch || true
          #  cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_namespace.c.patch ./
          #  patch -p1 < fix_namespace.c.patch || true
          #  cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_open.c.patch ./
          #  patch -p1 < fix_open.c.patch || true
          #  sed -i 's/i_uid_into_mnt(i_user_ns(inode), inode)/i_uid_into_mnt(inode->i_sb->s_user_ns, inode)/g' fs/susfs.c
          #fi

          # Use ACTUAL_SUBLEVEL for LTS or actual kernel sublevel if available
          #if ( [[ "${{ inputs.android_version }}" == "android12" ]] && [[ "${{ inputs.kernel_version }}" == "5.10" ]] && (( $ACTUAL_SUBLEVEL <= 43 )) ) \
          #  || ( [[ "${{ inputs.android_version }}" == "android14" ]] && [[ "${{ inputs.kernel_version }}" == "6.1" ]] && (( $ACTUAL_SUBLEVEL >= 145 )) ) \
          #  || ( [[ "${{ inputs.android_version }}" == "android15" ]] && [[ "${{ inputs.kernel_version }}" == "6.6" ]] && (( $ACTUAL_SUBLEVEL >= 98 )) ); then
          #  cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/1_fix_base.c.patch ./
          #  patch -p1 < 1_fix_base.c.patch || true
          #fi

          #if [[ "${{ inputs.android_version }}" == "android12" ]] && [[ "${{ inputs.kernel_version }}" == "5.10" ]] && (( $ACTUAL_SUBLEVEL <= 43 )); then
          #  cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/2_fix_base.c.patch ./
          #  patch -p1 < 2_fix_base.c.patch || true
          #fi

          #if ( [[ "${{ inputs.android_version }}" == "android15" ]] && [[ "${{ inputs.kernel_version }}" == "6.6" ]] && (( $ACTUAL_SUBLEVEL <= 58 )) ); then
          #  cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_task_mmu.c.patch ./
          #  patch -p1 < fix_task_mmu.c.patch || true
          #fi

          # Apply KSU integration patches
          cd ../Wild_KSU
          cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch .
          patch -p1 < 10_enable_susfs_for_ksu.patch || true
          
          cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_core_hook.c.patch ./
          patch -p1 < fix_core_hook.c.patch

          cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_sucompat.c.patch ./
          patch -p1 < fix_sucompat.c.patch

          cp ../../kernel_patches/wild/susfs_fix_patches/v${SUSFS_VERSION}/fix_kernel_compat.c.patch ./
          patch -p1 < fix_kernel_compat.c.patch

      - name: Apply Hooks Patches
        run: |
          cd "$CONFIG/kernel_platform/common"
          cp ../../../kernel_patches/wild/hooks/scope_min_manual_hooks_v1.4.patch ./
          patch -p1 -F 3 < scope_min_manual_hooks_v1.4.patch
          patch -p1 < fix_exec.patch

      - name: Add BBG
        run: |
          cd "$CONFIG/kernel_platform/common"
          echo "Adding BBG..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      - name: Set Kernel Configuration Variables
        run: |
          cd "$CONFIG/kernel_platform/common"
          echo "Initializing kernel configuration..."
          patch -p1 < config.patch
          
          # Remove check_defconfig
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Change Kernel Name
        run: |
          cd "$CONFIG"
          #Add Wild to Kernel Version
          sed -i '$s|echo "\$res"|echo "\$res-Wild"|' ./common/scripts/setlocalversion
          #Set Kernel Timestamp
          perl -pi -e 's{UTS_VERSION="\$\(echo \$UTS_VERSION \$CONFIG_FLAGS \$TIMESTAMP \| cut -b -\$UTS_LEN\)"}{UTS_VERSION="#1 SMP PREEMPT Sun Apr 20 04:20:00 UTC 2025"}' ./common/scripts/mkcompile_h
          if [ -f "build/build.sh" ]; then
            #Remove Dirty Flag
            sed -i 's/-dirty//' ./common/scripts/setlocalversion
          else
            #Remove Dirty Flag
            sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" ./build/kernel/kleaf/impl/stamp.bzl
            #Remove Abi Exports and Error
            #rm -rf ./common/android/abi_gki_protected_exports_*
            #perl -pi -e 's/^\s*"protected_exports_list"\s*:\s*"android\/abi_gki_protected_exports_aarch64",\s*$//;' ./common/BUILD.bazel
          fi

      - name: Set file name
        run: |
          ARTIFACT_BASE="${{ inputs.branch }}-${{ inputs.kernel_version }}-${{ inputs.android_version }}"
          echo "ARTIFACT_BASE=$ARTIFACT_BASE" >> $GITHUB_ENV
          echo "FILE_NAME=$ARTIFACT_BASE" >> $GITHUB_ENV

      - name: Build
        run : |
          set -e
          set -x
          cd "$CONFIG"
          echo "Building the kernel..."
          ./build_kernel_GKI.sh
          
      - name: Prepare AnyKernel3
        run: |
          # Copy Image from normal build locations
          if [ -f "./$CONFIG/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image" ]; then
            cp ./$CONFIG/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image AnyKernel3/Image
          elif [ -f "./$CONFIG/bazel-bin/common/kernel_aarch64/Image" ]; then
            cp ./$CONFIG/bazel-bin/common/kernel_aarch64/Image AnyKernel3/Image
          else
            echo "Error: Image file not found in any expected location"
            exit 1
          fi

      - name: Create Bootimgs Folder and Copy Images for Android 14/15
        if: ${{ inputs.android_version == 'android14' || inputs.android_version == 'android15' }}
        run: |
          mkdir bootimgs
          cp ./$CONFIG/bazel-bin/common/kernel_aarch64/Image ./bootimgs
          cp ./$CONFIG/bazel-bin/common/kernel_aarch64/Image.lz4 ./bootimgs
          cp ./$CONFIG/bazel-bin/common/kernel_aarch64/Image ./${{ env.FILE_NAME }}-Image
          cp ./$CONFIG/bazel-bin/common/kernel_aarch64/Image.lz4 ./${{ env.FILE_NAME }}-Image.lz4

          # Create gzip of the Image file
          gzip -n -k -f -9 ./${{ env.FILE_NAME }}-Image > ./${{ env.FILE_NAME }}-Image.gz
          gzip -n -k -f -9 ./bootimgs/Image > ./bootimgs/Image.gz
          cp ./boot-lz4.img ../${{ env.FILE_NAME }}-boot-lz4.img

      - name: Upload AnyKernel3 Artifacts
        id: upload_ak3
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}-AnyKernel3
          path: |
            ./AnyKernel3/**
          compression-level: 9
      
      - name: Scan and collect patch rejects
        if: ${{ always() }}
        run: |
          set -e
          CONFIG_DIR="$CONFIG"
          REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
          mkdir -p "$REJECTS_DIR"
          # Find all .rej files under the configuration directory
          mapfile -t REJS < <(find "$CONFIG_DIR" -type f -name '*.rej')
          REJ_COUNT=${#REJS[@]}
          echo "Found $REJ_COUNT .rej files under $CONFIG_DIR"
          echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
          if [ "$REJ_COUNT" -gt 0 ]; then
            for REJ in "${REJS[@]}"; do
              # Relative path from $CONFIG
              REL="${REJ#"$CONFIG_DIR"/}"
              DEST="$REJECTS_DIR/$REL"
              mkdir -p "$(dirname "$DEST")"
              cp "$REJ" "$DEST"
              # Copy the associated original file alongside the .rej
              ORIG="${REJ%.rej}"
              if [ -f "$ORIG" ]; then
                ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
                mkdir -p "$(dirname "$ORIG_DEST")"
                cp "$ORIG" "$ORIG_DEST"
              fi
              echo "$REL" >> "$REJECTS_DIR/index.txt"
            done
          fi

      - name: Generate Build Summary
        if: ${{ always() }}
        run: |
          # Create build summary file for inclusion in Misc artifact
          echo "# Kernel Build Summary" > build_summary.md
          
          # Add build variant header
          echo "## ${{ env.FILE_NAME }}" >> build_summary.md
          
          # Add build info
          echo "## Build Information" >> build_summary.md
          echo "- **Android Version**: ${{ inputs.android_version }}" >> build_summary.md
          echo "- **Kernel Version**: ${{ inputs.kernel_version }}.${{ inputs.sub_level }}" >> build_summary.md
          echo "- **BBG**: Installed" >> build_summary.md
          echo "- **Bypass Mode**: ${{ matrix.apply_bypass }}" >> build_summary.md
          echo "" >> build_summary.md

          # Get Wild_KSU commit
          if [ -d "$CONFIG/Wild_KSU" ]; then
            cd "$CONFIG/Wild_KSU"
            WKSU_COMMIT=$(git rev-parse HEAD)
            WKSU_URL="https://github.com/WildKernels/Wild_KSU/commit/$WKSU_COMMIT"
            echo "- **Wild_KSU**: [$WKSU_COMMIT]($WKSU_URL)" >> "$GITHUB_WORKSPACE/build_summary.md"
            cd "$GITHUB_WORKSPACE"
          else
            echo "- **Wild_KSU**: not present" >> build_summary.md
          fi
          
          # Get Baseband-guard commit
          if [ -d "$CONFIG/Baseband-guard" ]; then
            cd "$CONFIG/Baseband-guard"
            BBG_COMMIT=$(git rev-parse HEAD)
            BBG_URL="https://github.com/vc-teahouse/Baseband-guard/commit/$BBG_COMMIT"
            echo "- **Baseband-guard**: [$BBG_COMMIT]($BBG_URL)" >> "$GITHUB_WORKSPACE/build_summary.md"
            cd "$GITHUB_WORKSPACE"
          else
            echo "- **Baseband-guard**: not present" >> build_summary.md
          fi
          
          # Get SUSFS4KSU commit
          if [ -d "$GITHUB_WORKSPACE/susfs4ksu" ]; then
            cd "$GITHUB_WORKSPACE/susfs4ksu"
            SUSFS_COMMIT=$(git rev-parse HEAD)
            SUSFS_URL="https://gitlab.com/simonpunk/susfs4ksu/-/commit/$SUSFS_COMMIT"
            echo "- **SUSFS4KSU (v1.5.12)**: [$SUSFS_COMMIT]($SUSFS_URL)" >> "$GITHUB_WORKSPACE/build_summary.md"
            cd "$GITHUB_WORKSPACE"
          else
            echo "- **SUSFS4KSU (v1.5.12)**: not present" >> build_summary.md
          fi
          echo "" >> build_summary.md
          
          # Add artifact summary with presence verification
          echo "## Build Artifacts" >> build_summary.md

          # Verify AnyKernel3 contents - check if kernel Image was actually copied (indicates successful build)
          if [ -d "AnyKernel3" ] && [ -f "AnyKernel3/Image" ]; then
            AK3_STATUS="✅"
          else
            AK3_STATUS="❌"
          fi
          echo "- **AnyKernel3**: $AK3_STATUS ${{ env.FILE_NAME }}-AnyKernel3" >> build_summary.md

          echo "### Misc (uploaded files)" >> build_summary.md
          FILES_PRESENT=0
          for f in "${{ env.FILE_NAME }}-Image" "${{ env.FILE_NAME }}-Image.gz" "${{ env.FILE_NAME }}-Image.lz4" "${{ env.FILE_NAME }}-boot.img" "${{ env.FILE_NAME }}-boot-gz.img" "${{ env.FILE_NAME }}-boot-lz4.img"; do
            if [ -f "$f" ]; then FILES_PRESENT=$((FILES_PRESENT+1)); fi
          done
          if [ "$FILES_PRESENT" -gt 0 ]; then
            MISC_STATUS="✅"
          else
            MISC_STATUS="❌"
          fi
          echo "- **Set**: $MISC_STATUS ${{ env.FILE_NAME }}-Misc" >> build_summary.md
          if [ "$MISC_STATUS" = "✅" ]; then
            echo "  Included:" >> build_summary.md
            for f in "${{ env.FILE_NAME }}-Image" "${{ env.FILE_NAME }}-Image.gz" "${{ env.FILE_NAME }}-Image.lz4" "${{ env.FILE_NAME }}-boot.img" "${{ env.FILE_NAME }}-boot-gz.img" "${{ env.FILE_NAME }}-boot-lz4.img"; do
              if [ -f "$f" ]; then
                echo "  - $f" >> build_summary.md
              fi
            done
          fi

          echo "### Diagnostics" >> build_summary.md
          echo "- **Rejected Patches**: ${{ env.FILE_NAME }}-Rejected-Patches" >> build_summary.md
          if [ -f patch-rejects/index.txt ]; then
            if [ -s patch-rejects/index.txt ]; then
              echo "  Rejected files:" >> build_summary.md
              while IFS= read -r line; do
                echo "    - $line" >> build_summary.md
              done < patch-rejects/index.txt
            else
              echo "  Rejected file list is empty." >> build_summary.md
            fi
          else
            echo "  No rejected patches found." >> build_summary.md
          fi
